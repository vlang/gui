# Milestone v1.0: Gradient Rendering MVP

**Status:** ✅ SHIPPED 2026-02-01
**Phases:** 1-3
**Total Plans:** 8

## Overview

Replace v-gui's 2-color vertex interpolation with fragment shader multi-stop gradients. Three
phases: establish fragment shader pipeline foundation, implement linear gradients with direction
control, add radial gradient support. Delivers CSS-compatible gradients without artifacts.

## Phases

### Phase 1: Fragment Shader Foundation

**Goal**: Replace vertex interpolation with fragment shader pipeline that renders multi-stop
gradients without artifacts
**Depends on**: Nothing (first phase)
**Requirements**: INF-01, INF-02, INF-03, INF-04, INF-05
**Success Criteria**:
  1. Fragment shader renders gradients with 3+ stops at arbitrary positions
  2. Metal shader (macOS) and GLSL shader (Linux/Windows) produce identical output
  3. Gradients render without visible color banding (dithering applied)
  4. Colors interpolate with premultiplied alpha (no grey artifacts on transparency)
**Plans**: 4 plans

Plans:
- [x] 01-01-PLAN.md — Create GLSL and Metal gradient shaders with dithering
- [x] 01-02-PLAN.md — Add gradient pipeline infrastructure to Window and shaders.v
- [x] 01-03-PLAN.md — Wire render.v to use gradient pipeline, visual verification
- [x] 01-04-PLAN.md — Fix premultiplied alpha interpolation (gap closure)

**Details:**
- GLSL/Metal shader source strings with vs_gradient and fs_gradient
- tm matrix packing: rows (GLSL) / columns (Metal) store vec4(r,g,b,pos)
- gradient_pip pipeline following shadow_pip pattern
- draw_gradient_rect API for rendering

### Phase 2: Linear Gradients

**Goal**: Users can define linear gradients with arbitrary direction/angle matching CSS behavior
**Depends on**: Phase 1
**Requirements**: LIN-01, LIN-02, LIN-03
**Success Criteria**:
  1. User can specify gradient angle via degrees (45deg, 90deg, etc.)
  2. User can specify gradient direction via CSS keywords (to top, to bottom-right, etc.)
  3. Gradient renders correctly at all angles (0-360 degrees)
**Plans**: 2 plans

Plans:
- [x] 02-01-PLAN.md — Add Direction enum and angle support to Gradient struct
- [x] 02-02-PLAN.md — Update shaders to use direction vector, visual verification

**Details:**
- Direction enum with 8 CSS keywords (to_top, to_right, to_bottom_left, etc.)
- angle ?f32 field overrides direction keyword when set
- Corner keywords use atan2 for aspect-ratio-correct angles
- Direction vector packed into tm[3].xy
- Shader projection: dot(uv, dir) * 0.5 + 0.5

### Phase 3: Radial Gradients

**Goal**: Users can define circular radial gradients with multi-stop interpolation
**Depends on**: Phase 2
**Requirements**: RAD-01, RAD-02
**Success Criteria**:
  1. User can define radial gradient from center with 3+ stops
  2. Radial gradient renders as perfect circle regardless of element aspect ratio
  3. Color interpolation from center to edge matches CSS spec
**Plans**: 2 plans

Plans:
- [x] 03-01-PLAN.md — Pack radial gradient parameters (aspect ratio, type flag) into tm matrix
- [x] 03-02-PLAN.md — Update shaders for radial t calculation, visual verification

**Details:**
- Gradient type flag in tm[3].z (1.0 = radial, 0.0 = linear)
- Aspect ratio packed in tm[3].xy for radial (longer axis = 1.0)
- grad_type varying passes type from VS to FS
- Radial t = length(uv * aspect) for perfect circles

---

## Milestone Summary

**Key Decisions:**

| Decision | Phase | Rationale |
|----------|-------|-----------|
| tm matrix packing for 3 gradient stops | 01-01 | tm[0..2] as vec4(r,g,b,pos), GLSL rows / Metal columns |
| Premultiplied alpha interpolation | 01-01 | Prevents gray artifacts on transparent gradients per CSS spec |
| Screen-space dithering for banding | 01-01 | Breaks up 8-bit quantization artifacts in gradients |
| gradient_pip follows shadow_pip pattern | 01-02 | Vertex layout, uniforms, blending match existing pipelines |
| Pass stop data via varyings not FS uniforms | 01-03 | VS reads tm matrix, passes stop0/1/2 as varyings |
| Direction default is .to_bottom (180deg) | 02-01 | Matches CSS spec, ensures backward compatibility |
| Corner keywords use atan2 for aspect ratio | 02-01 | Matches CSS behavior for corner-based gradients |
| Direction vector packed into tm[3].xy | 02-01 | Shader reads gradient direction from tm matrix |
| dot(uv, dir) for directional projection | 02-02 | Standard GPU technique, projects UV onto direction vector |
| tm[3].z as gradient type flag | 03-01 | 1.0 = radial, 0.0 = linear; shader checks > 0.5 |
| Aspect ratio for radial circles | 03-01 | Longer axis = 1.0, shorter = ratio; ensures perfect circles |
| Radial uses length(uv * aspect) | 03-02 | Distance from center, normalized to 1.0 at closest edge |

**Issues Resolved:**
- 2-color vertex interpolation hack replaced with proper fragment shader
- Gray artifacts on transparent gradients fixed via premultiplied alpha
- Color banding eliminated via dithering

**Issues Deferred:**
- 4+ stop gradients (current limit: 3 stops in tm matrix)
- Elliptical radial gradients (only circular supported)
- Custom radial center position

**Technical Debt Incurred:**
- Stop format uses .a/.w for position, limiting per-stop alpha control

---

_For current project status, see .planning/ROADMAP.md_
