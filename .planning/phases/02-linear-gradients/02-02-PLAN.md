---
phase: 02-linear-gradients
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - shaders_glsl.v
  - shaders_metal.v
autonomous: false

must_haves:
  truths:
    - "Gradient direction changes visual angle of color transition"
    - "to_top shows first color at bottom, last at top"
    - "to_right shows first color at left, last at right"
    - "45deg diagonal shows correct angle"
    - "Corner keywords point to actual corners regardless of aspect ratio"
  artifacts:
    - path: "shaders_glsl.v"
      provides: "GLSL gradient shader with direction support"
      contains: "stop_dir"
    - path: "shaders_metal.v"
      provides: "Metal gradient shader with direction support"
      contains: "stop_dir"
  key_links:
    - from: "shaders_glsl.v"
      to: "tm[3]"
      via: "direction vector read in VS"
      pattern: "tm\\[3\\]"
    - from: "shaders_metal.v"
      to: "tm[3]"
      via: "direction vector read in VS"
      pattern: "tm\\[3\\]"
---

<objective>
Update GLSL and Metal gradient shaders to use direction vector for gradient calculation

Purpose: Complete linear gradient direction support by reading tm[3] in shaders
Output: Working directional gradients verified visually
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-linear-gradients/02-CONTEXT.md
@.planning/phases/02-linear-gradients/02-RESEARCH.md
@.planning/phases/02-linear-gradients/02-01-SUMMARY.md
@shaders_glsl.v
@shaders_metal.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update GLSL and Metal gradient shaders</name>
  <files>shaders_glsl.v, shaders_metal.v</files>
  <action>
**GLSL (shaders_glsl.v):**

1. Update vs_gradient_glsl to pass direction:
   - Add `out vec2 stop_dir;` to outputs
   - In main(): `stop_dir = tm[3].xy;`

2. Update fs_gradient_glsl:
   - Add `in vec2 stop_dir;` to inputs
   - Replace t calculation:
     ```glsl
     // OLD: float t = uv.x * 0.5 + 0.5;
     // NEW: Project uv onto direction vector
     vec2 dir = stop_dir;
     float t = dot(uv, dir) * 0.5 + 0.5;
     t = clamp(t, 0.0, 1.0);
     ```

**Metal (shaders_metal.v):**

1. Update VertexOut struct in vs_gradient_metal to add:
   ```metal
   float2 stop_dir;
   ```

2. Update vs_main to pass direction:
   ```metal
   out.stop_dir = uniforms.tm[3].xy;
   ```

3. Update VertexOut struct in fs_gradient_metal to add:
   ```metal
   float2 stop_dir;
   ```

4. Update fs_main t calculation:
   ```metal
   // OLD: float t = in.uv.x * 0.5 + 0.5;
   // NEW: Project uv onto direction vector
   float2 dir = in.stop_dir;
   float t = dot(in.uv, dir) * 0.5 + 0.5;
   t = clamp(t, 0.0, 1.0);
   ```

Key points:
- Both shaders read direction from tm[3].xy (packed by render.v)
- dot(uv, dir) projects UV onto direction line
- * 0.5 + 0.5 maps -1..1 to 0..1
- clamp ensures t stays in valid range

Format with: `v fmt -w shaders_glsl.v && v fmt -w shaders_metal.v`
  </action>
  <verify>`v .` compiles successfully</verify>
  <done>Both shaders read direction and compute directional t value</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Linear gradient direction support:
- Direction enum (to_top, to_right, to_bottom_left, etc.)
- Optional angle field (degrees)
- Shaders compute gradient along specified direction
  </what-built>
  <how-to-verify>
1. Open examples/gradient_demo.v
2. Modify a gradient to test different directions:
   ```v
   gradient: &gui.Gradient{
       stops: [
           gui.GradientStop{color: gui.Color{255, 0, 0, 255}, pos: 0.0},
           gui.GradientStop{color: gui.Color{0, 0, 255, 255}, pos: 1.0},
       ]
       direction: .to_top  // Should show red at bottom, blue at top
   }
   ```
3. Run: `v run examples/gradient_demo.v`
4. Verify:
   - .to_bottom (default): red at top, blue at bottom
   - .to_top: red at bottom, blue at top
   - .to_right: red at left, blue at right
   - .to_left: red at right, blue at left
   - .to_bottom_right: diagonal from top-left to bottom-right
5. Test explicit angle:
   ```v
   angle: 45.0  // 45 degree diagonal
   ```
6. Verify 45deg shows diagonal from bottom-left to top-right
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual issues</resume-signal>
</task>

</tasks>

<verification>
- `v .` compiles without errors
- Gradient renders with correct direction based on direction enum
- Gradient renders with correct angle when angle field specified
- Default (to_bottom/180deg) matches existing behavior
- Corner keywords adapt to element aspect ratio
</verification>

<success_criteria>
- GLSL shader reads stop_dir from tm[3].xy and computes directional t
- Metal shader reads stop_dir from tm[3].xy and computes directional t
- Visual verification confirms all 8 direction keywords work correctly
- Explicit angle overrides direction keyword
- No visual artifacts or regressions from Phase 1
</success_criteria>

<output>
After completion, create `.planning/phases/02-linear-gradients/02-02-SUMMARY.md`
</output>
