---
phase: 03-radial-gradients
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - shaders_glsl.v
  - shaders_metal.v
autonomous: false

must_haves:
  truths:
    - "Radial gradient renders as perfect circle on square element"
    - "Radial gradient renders as perfect circle on wide rectangle"
    - "Radial gradient renders as perfect circle on tall rectangle"
    - "Linear gradients still render correctly after shader changes"
  artifacts:
    - path: "shaders_glsl.v"
      provides: "GLSL radial gradient t calculation"
      contains: "length(uv * aspect)"
    - path: "shaders_metal.v"
      provides: "Metal radial gradient t calculation"
      contains: "length(in.uv * aspect)"
  key_links:
    - from: "fs_gradient_glsl"
      to: "stop_dir"
      via: "type flag branch"
      pattern: "stop_dir\\.z.*0\\.5"
    - from: "fs_gradient_metal"
      to: "stop_dir"
      via: "type flag branch"
      pattern: "stop_dir\\.z.*0\\.5"
---

<objective>
Update GLSL and Metal gradient shaders to support radial gradients via type flag branching.

Purpose: Radial gradients compute t from distance to center (with aspect correction) instead of
directional projection.

Output: Unified gradient shaders that render both linear and radial gradients correctly.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-radial-gradients/03-RESEARCH.md
@.planning/phases/03-radial-gradients/03-01-SUMMARY.md

@shaders_glsl.v (vs_gradient_glsl, fs_gradient_glsl)
@shaders_metal.v (vs_gradient_metal, fs_gradient_metal)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gradient type varying and update shaders</name>
  <files>shaders_glsl.v, shaders_metal.v</files>
  <action>
**GLSL Changes (shaders_glsl.v):**

1. In vs_gradient_glsl, add new varying to pass type flag:
```glsl
out float grad_type;
```
And in main():
```glsl
grad_type = tm[3].z;
```

2. In fs_gradient_glsl, add corresponding input:
```glsl
in float grad_type;
```

3. Replace the t calculation section (lines ~245-248) with unified logic:
```glsl
// Unified gradient t calculation
float t;
if (grad_type > 0.5) {
    // Radial: distance from center with aspect correction
    vec2 aspect = stop_dir;
    t = length(uv * aspect);
} else {
    // Linear: project onto direction vector
    vec2 dir = stop_dir;
    t = dot(uv, dir) * 0.5 + 0.5;
}
t = clamp(t, 0.0, 1.0);
```

**Metal Changes (shaders_metal.v):**

1. In VertexOut struct (vs_gradient_metal), add:
```metal
float grad_type;
```

2. In vs_main, add:
```metal
out.grad_type = uniforms.tm[3].z;
```

3. In fs_gradient_metal, replace t calculation with:
```metal
// Unified gradient t calculation
float t;
if (in.grad_type > 0.5) {
    // Radial: distance from center with aspect correction
    float2 aspect = in.stop_dir;
    t = length(in.uv * aspect);
} else {
    // Linear: project onto direction vector
    float2 dir = in.stop_dir;
    t = dot(in.uv, dir) * 0.5 + 0.5;
}
t = clamp(t, 0.0, 1.0);
```

Key points:
- grad_type > 0.5 distinguishes radial (1.0) from linear (0.0)
- For radial: length(uv * aspect) gives distance from center, normalized to 1.0 at closest edge
- For linear: existing dot product projection preserved
- Both clamp t to [0,1]
  </action>
  <verify>
Run `v -check-syntax shaders_glsl.v shaders_metal.v` to verify no syntax errors.
Run `v fmt -w shaders_glsl.v shaders_metal.v` to format.
Run `v .` in project root to compile.
  </verify>
  <done>
Both shaders read grad_type varying, branch on type, and compute appropriate t value for
linear or radial gradients.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of radial gradients</name>
  <what-built>Radial gradient rendering with perfect circles on any aspect ratio</what-built>
  <how-to-verify>
Create a test file or modify existing demo to show radial gradients:

```v
// Test radial gradient on different aspect ratios
fn test_radial_gradients() {
    // Square element
    rectangle(
        width: .fixed(200)
        height: .fixed(200)
        style: RectangleStyle{
            gradient: &Gradient{
                type: .radial
                stops: [
                    GradientStop{color: Color{255, 0, 0, 255}, pos: 0.0}
                    GradientStop{color: Color{0, 255, 0, 255}, pos: 0.5}
                    GradientStop{color: Color{0, 0, 255, 255}, pos: 1.0}
                ]
            }
        }
    )
    // Wide rectangle
    rectangle(
        width: .fixed(300)
        height: .fixed(100)
        style: RectangleStyle{
            gradient: &Gradient{
                type: .radial
                stops: [
                    GradientStop{color: Color{255, 255, 0, 255}, pos: 0.0}
                    GradientStop{color: Color{0, 255, 255, 255}, pos: 1.0}
                ]
            }
        }
    )
    // Tall rectangle
    rectangle(
        width: .fixed(100)
        height: .fixed(300)
        style: RectangleStyle{
            gradient: &Gradient{
                type: .radial
                stops: [
                    GradientStop{color: Color{255, 0, 255, 255}, pos: 0.0}
                    GradientStop{color: Color{0, 0, 0, 255}, pos: 1.0}
                ]
            }
        }
    )
}
```

Verify:
1. Square element: Gradient radiates from center as perfect circle
2. Wide rectangle: Gradient is a perfect circle (touches top/bottom edges first)
3. Tall rectangle: Gradient is a perfect circle (touches left/right edges first)
4. Linear gradients still work correctly (test existing gradient demos)
5. Corners beyond circle edge show last color (clamped to 1.0)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual issues</resume-signal>
</task>

</tasks>

<verification>
- GLSL shader compiles (v . succeeds)
- Metal shader compiles (v . succeeds on macOS)
- Radial gradient renders as circle on square element
- Radial gradient renders as circle on non-square elements
- Linear gradients unchanged
</verification>

<success_criteria>
- Radial gradients render as perfect circles regardless of element aspect ratio
- Color interpolation from center (t=0) to edge (t=1) works with 3 stops
- Linear gradients continue to work correctly
- Both GLSL and Metal backends produce identical output
</success_criteria>

<output>
After completion, create `.planning/phases/03-radial-gradients/03-02-SUMMARY.md`
</output>
